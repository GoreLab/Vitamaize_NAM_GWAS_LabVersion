rm(list = ls())

###Required Files:
### (1) Raw P values files from script (5-3)



library(gplots)
#Set the working directory
setwd("C:\\Users\\ceb19\\Documents\\Gore Lab\\Carotenoid NAM Merged Env\\(15)Correlated Expression\\JL_GWAS_FPKM_overlap_analysis\\")
home.dir <- getwd()
location.of.raw.P.value.results <- "\\Significance Threshold\\FDR_Corrected_Corr_Results\\"    #also in specific trait folder
output.dir <- "\\Significance Threshold\\Heatmaps_of_Gene_Ranks\\"

list.of.traits <- c("ACAR_RUV", "BCAR_RUV", "BCRY_RUV", "LUT_RUV", "PHYF_RUV", "THLYC_RUV", "TOTCAR_RUV", "ZEA_RUV", "ZEI_RUV")
top.five.or.something.else <- "5" #Options any integer in quotes

#For loop through the traits
for(trait in list.of.traits){
  setwd(paste(home.dir, location.of.raw.P.value.results, trait, "\\", sep = ""))
  
  #Read in the raw P-values
  the.raw.P.values <- read.table(paste("Raw.P.values.for.",trait, ".txt",sep = ""), head = TRUE)

  setwd(paste(home.dir, output.dir, sep = ""))
  #For looop through each QTL
  for(QTL in as.character(unique(the.raw.P.values[,ncol(the.raw.P.values)]))){
    the.raw.P.values.for.this.QTL <- the.raw.P.values[which(the.raw.P.values[,ncol(the.raw.P.values)] == QTL),]
    
    #create subdirectories
    #trait.subdirectory <- paste("P-value_Heatmaps_for_", trait, "\\", sep = "")
    #dir.create(paste(home.dir, output.dir, trait.subdirectory, sep = ""))
    #setwd(paste(home.dir, output.dir, trait.subdirectory, sep = ""))
    
    #Start a pdf device
    pdf(paste("Top.",top.five.or.something.else,".Genes.Associated.with.",trait,".",QTL,".on.", the.raw.P.values.for.this.QTL[1,(ncol(the.raw.P.values.for.this.QTL)-3)],".pdf" , sep = ""), width = 14)

    #For loop through each time point
    for(time.point in 2:7){
      #Sort from smallest to largest P-value
      the.raw.P.values.for.this.QTL <- the.raw.P.values.for.this.QTL[order(the.raw.P.values.for.this.QTL[,time.point]),]
      
      the.top.P.values.for.this.QTL <- the.raw.P.values.for.this.QTL[1:as.numeric(top.five.or.something.else),]

      #Write a text file that will give information about the
      write.table(the.top.P.values.for.this.QTL, paste("FPKM.matrix.for.top.",top.five.or.something.else,".Genes.Associated.with.",trait,".",QTL,".on.", the.raw.P.values.for.this.QTL[1,(ncol(the.raw.P.values.for.this.QTL)-3)],".",
                                     substr(colnames(the.top.P.values.for.this.QTL)[time.point], start = 2, stop = 1000), ".txt", sep = ""), quote = FALSE, sep = "\t", row.names = TRUE,col.names = TRUE)
      
      #Make a heatmap of the "top 5" genes with the strongest association
      data.for.heatmap <- as.matrix(the.top.P.values.for.this.QTL[,2:7])
      data.for.heatmap[which(is.na(data.for.heatmap))] = 1
      #Take the -log10 P-values so that the stronger correlations are darker in the heatmap
      data.for.heatmap <- -log10(data.for.heatmap)
      rownames(data.for.heatmap) <- the.top.P.values.for.this.QTL[,1]
      
      abs.max <- max(abs(data.for.heatmap))
      increments <- (2*abs.max)/20
      breaks = seq(-abs.max, abs.max, by = increments)  
      heatmap.2(data.for.heatmap, dendrogram = "none", Rowv = FALSE, Colv = "Rowv", trace = "none", 
                key = TRUE, col = bluered, ylab = NULL, breaks = breaks,  
                margins = c(5,10), cexRow = 0.7, cexCol = 0.7, main = paste("Top ", top.five.or.something.else, " Correlated Genes at ", 
                                                                            substr(colnames(the.top.P.values.for.this.QTL)[time.point], start = 2, stop = 1000), "(-log10 P-value)" , sep = ""))      
        
    }#End for loop through each time point


    dev.off()
    #Turn off the pdf device
  


  }#End for loop through each QTL



} #End for(trait in list.of.traits)

